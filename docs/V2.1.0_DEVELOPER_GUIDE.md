# WebScrape-TUI v2.1.0 - Developer Guide

**Version**: v2.1.0 (in development)
**Last Updated**: October 3, 2025
**Status**: Foundation complete, core refactoring in progress

## Quick Start for Developers

### Prerequisites

- Python 3.8-3.12 (3.10-3.12 recommended)
- Git
- Virtual environment tool
- Text editor/IDE with Python support

### Setting Up Development Environment

```bash
# Clone repository
cd /home/parobek/Code/WebScrape-TUI

# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements-v2.1.0.txt

# Install development dependencies
pip install pytest pytest-asyncio pytest-mock pytest-cov black ruff mypy httpx

# Download spaCy model
python -m spacy download en_core_web_sm

# Run existing tests (v2.0.0)
# Note: pytest may not be installed yet
# pip install pytest pytest-asyncio first
# pytest tests/ -v
```

### Project Structure (v2.1.0)

```
webscrape-tui/
├── scrapetui/                   # Main package (NEW modular structure)
│   ├── core/                    # Core functionality
│   │   ├── auth.py ✓           # Authentication (323 lines)
│   │   ├── database.py ✓       # Database layer (92 lines)
│   │   ├── permissions.py ✓    # RBAC system (150 lines)
│   │   └── cache.py            # Caching (pending)
│   ├── models/                  # Data models (pending)
│   ├── database/                # Database layer (pending)
│   │   ├── schema.py           # Database schema
│   │   ├── migrations.py       # Migration system
│   │   └── queries.py          # Query builders
│   ├── scrapers/                # Scraping system (pending)
│   ├── ai/                      # AI providers (pending)
│   ├── ui/                      # TUI components (pending)
│   ├── api/                     # REST API (pending)
│   ├── cli/                     # CLI interface (pending)
│   ├── utils/                   # Utilities
│   │   ├── logging.py ✓        # Logging system (51 lines)
│   │   └── errors.py ✓         # Custom exceptions (52 lines)
│   ├── config.py ✓             # Configuration (177 lines)
│   └── constants.py ✓          # Constants/enums (65 lines)
│
├── scrapetui.py                 # Legacy entry point (9,808 lines - to be refactored)
├── tests/                       # Test suite
│   ├── test_v2_auth_phase1.py  # Phase 1 auth tests
│   ├── test_v2_ui_phase2.py    # Phase 2 UI tests
│   ├── test_v2_phase3_isolation.py  # Phase 3 isolation tests
│   ├── unit/                    # Unit tests (NEW)
│   ├── integration/             # Integration tests (NEW)
│   └── e2e/                     # End-to-end tests (NEW)
│
├── docs/                        # Documentation
│   ├── V2.1.0_REFACTOR_REPORT.md        # Main implementation report
│   ├── V2.1.0_SESSION_SUMMARY.md        # Session summary
│   ├── V2.1.0_DEVELOPER_GUIDE.md        # This file
│   ├── ROADMAP.md               # Future plans
│   └── ARCHITECTURE.md          # Architecture docs
│
├── pyproject.toml ✓            # Modern Python packaging
├── requirements-v2.1.0.txt ✓   # Dependencies
├── requirements.txt             # Legacy dependencies
└── README.md                    # Main documentation
```

## Current Status

### Completed Modules ✓

1. **scrapetui/config.py** (177 lines)
   - Configuration dataclass
   - Environment variable loading
   - All settings (database, API, cache, etc.)

2. **scrapetui/constants.py** (65 lines)
   - Role enum
   - AI provider enums
   - Default constants

3. **scrapetui/utils/logging.py** (51 lines)
   - Centralized logging
   - Logger factory

4. **scrapetui/utils/errors.py** (52 lines)
   - Custom exception hierarchy

5. **scrapetui/core/auth.py** (323 lines)
   - Password hashing (bcrypt)
   - Session management
   - User authentication

6. **scrapetui/core/database.py** (92 lines)
   - Connection context manager
   - Database initialization

7. **scrapetui/core/permissions.py** (150 lines)
   - RBAC implementation
   - Permission checking

### In Progress 🔄

1. **scrapetui/core/cache.py**
   - Memory cache class
   - Redis cache class
   - Cache decorator

2. **scrapetui/database/schema.py**
   - Extract from scrapetui.py lines 978-1309
   - 18 table definitions
   - Index creation

### Pending ⏳

See V2.1.0_REFACTOR_REPORT.md for full list of remaining tasks.

## Development Workflow

### Adding a New Module

1. **Create the module file**
   ```bash
   # Example: creating cache module
   touch scrapetui/core/cache.py
   ```

2. **Write module with proper structure**
   ```python
   """Module description."""

   from ..utils.logging import get_logger
   from ..config import init_config

   logger = get_logger(__name__)

   class MyClass:
       """Class description."""

       def __init__(self):
           """Initialize."""
           pass
   ```

3. **Update __init__.py**
   ```python
   # scrapetui/core/__init__.py
   from .auth import hash_password, verify_password
   from .database import get_db_connection
   from .permissions import check_permission
   # Add new exports
   ```

4. **Write tests**
   ```python
   # tests/unit/test_mymodule.py
   import pytest
   from scrapetui.core.mymodule import MyClass

   def test_my_feature():
       obj = MyClass()
       assert obj is not None
   ```

5. **Run tests**
   ```bash
   pytest tests/unit/test_mymodule.py -v
   ```

### Extracting Code from scrapetui.py

**Process:**

1. **Identify the code section**
   - Note line numbers
   - Understand dependencies

2. **Read the section**
   ```bash
   # Example: read lines 1000-1100
   sed -n '1000,1100p' scrapetui.py
   ```

3. **Create new module**
   - Copy code to new file
   - Update imports
   - Add proper docstrings

4. **Test in isolation**
   - Write unit tests
   - Ensure functionality preserved

5. **Update original file**
   - Import from new module
   - Remove duplicated code (later phase)

### Running Tests

```bash
# Run all tests
pytest tests/ -v

# Run specific test file
pytest tests/unit/test_auth.py -v

# Run with coverage
pytest tests/ --cov=scrapetui --cov-report=html

# Run only fast tests
pytest tests/unit/ -v

# Run integration tests
pytest tests/integration/ -v
```

### Code Quality Checks

```bash
# Format code
black scrapetui/

# Lint code
ruff check scrapetui/

# Type check
mypy scrapetui/

# Run all checks
black scrapetui/ && ruff check scrapetui/ && mypy scrapetui/
```

## Key Design Patterns

### 1. Dependency Injection

**Pattern**: Inject configuration and dependencies rather than hardcoding.

```python
# Good
from ..config import init_config

def my_function():
    config = init_config()
    db_path = config.database_path

# Avoid
def my_function():
    db_path = "scraped_data_tui_v1.0.db"  # Hardcoded
```

### 2. Context Managers

**Pattern**: Use context managers for resource management.

```python
# Good
from ..core.database import get_db_connection

with get_db_connection() as conn:
    cursor = conn.execute("SELECT * FROM users")
    # conn.close() called automatically

# Avoid
conn = sqlite3.connect("db.db")
cursor = conn.execute("SELECT * FROM users")
conn.close()  # Easy to forget
```

### 3. Logging

**Pattern**: Use centralized logger, not print statements.

```python
# Good
from ..utils.logging import get_logger

logger = get_logger(__name__)
logger.info("Processing started")
logger.error(f"Error: {e}", exc_info=True)

# Avoid
print("Processing started")  # Not logged to file
print(f"Error: {e}")  # No stack trace
```

### 4. Error Handling

**Pattern**: Use specific exceptions from utils.errors.

```python
# Good
from ..utils.errors import AuthenticationError

if not valid:
    raise AuthenticationError("Invalid credentials")

# Avoid
if not valid:
    raise Exception("Invalid credentials")  # Too generic
```

### 5. Type Hints

**Pattern**: Use type hints for better IDE support and documentation.

```python
# Good
from typing import Optional, List

def get_user(user_id: int) -> Optional[dict]:
    """Get user by ID."""
    pass

def get_tags() -> List[str]:
    """Get all tags."""
    pass

# Acceptable but less helpful
def get_user(user_id):
    """Get user by ID."""
    pass
```

## Common Tasks

### Adding a New API Endpoint

1. Create route function in `scrapetui/api/routes/`
2. Add Pydantic models in `scrapetui/api/models.py`
3. Register route in `scrapetui/api/main.py`
4. Write integration test in `tests/integration/test_api.py`
5. Document in `docs/API.md`

### Adding a New CLI Command

1. Create command function in `scrapetui/cli/commands/`
2. Use Click decorators
3. Register in `scrapetui/cli/main.py`
4. Write CLI test in `tests/integration/test_cli.py`
5. Document in `docs/CLI.md`

### Adding a New Scraper Plugin

1. Create class inheriting from `BaseScraper`
2. Implement `can_handle()` and `scrape()` methods
3. Place in `scrapetui/scrapers/builtin/` or `plugins/scrapers/`
4. Write scraper tests
5. Document in `docs/PLUGINS.md`

### Adding a New AI Provider

1. Create class inheriting from `BaseAIProvider`
2. Implement required methods
3. Place in `scrapetui/ai/`
4. Write provider tests
5. Update configuration

## Testing Guidelines

### Unit Tests

**Purpose**: Test individual functions/classes in isolation.

```python
# tests/unit/test_auth.py
import pytest
from scrapetui.core.auth import hash_password, verify_password

def test_hash_password():
    password = "testpass123"
    hashed = hash_password(password)
    assert hashed != password
    assert len(hashed) > 0

def test_verify_password():
    password = "testpass123"
    hashed = hash_password(password)
    assert verify_password(password, hashed) is True
    assert verify_password("wrongpass", hashed) is False
```

### Integration Tests

**Purpose**: Test multiple components working together.

```python
# tests/integration/test_api.py
import pytest
from httpx import AsyncClient
from scrapetui.api.main import app

@pytest.mark.asyncio
async def test_login_endpoint():
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post(
            "/api/auth/login",
            json={"username": "admin", "password": "Ch4ng3M3"}
        )
    assert response.status_code == 200
    assert "access_token" in response.json()
```

### Test Fixtures

```python
# tests/conftest.py
import pytest
from pathlib import Path
import tempfile

@pytest.fixture
def temp_db():
    """Create temporary database for testing."""
    with tempfile.NamedTemporaryFile(suffix=".db") as f:
        db_path = Path(f.name)
        # Initialize test database
        yield db_path
        # Cleanup handled by context manager
```

## Documentation Standards

### Module Docstrings

```python
"""
Module description here.

This module provides functionality for X, Y, and Z.
It is used by A and integrates with B.
"""
```

### Function Docstrings

```python
def my_function(param1: int, param2: str) -> bool:
    """
    Brief description of what function does.

    Longer description if needed, explaining behavior,
    edge cases, and important notes.

    Args:
        param1: Description of param1
        param2: Description of param2

    Returns:
        Description of return value

    Raises:
        ValueError: When param1 is negative
        KeyError: When param2 is invalid

    Example:
        >>> my_function(42, "test")
        True
    """
    pass
```

### Class Docstrings

```python
class MyClass:
    """
    Brief description of class purpose.

    Longer description explaining responsibilities,
    usage patterns, and important notes.

    Attributes:
        attr1: Description of attr1
        attr2: Description of attr2

    Example:
        >>> obj = MyClass()
        >>> obj.method()
    """

    def __init__(self, param: int):
        """Initialize MyClass with param."""
        self.attr1 = param
```

## Troubleshooting

### Import Errors

**Problem**: `ModuleNotFoundError: No module named 'scrapetui'`

**Solution**:
```bash
# Make sure you're in the project root
cd /home/parobek/Code/WebScrape-TUI

# Install package in editable mode
pip install -e .

# Or add to PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:/home/parobek/Code/WebScrape-TUI"
```

### Database Errors

**Problem**: `sqlite3.OperationalError: no such table: users`

**Solution**:
```python
from scrapetui.core.database import init_db
init_db()  # Initialize database schema
```

### Test Failures

**Problem**: Tests fail due to missing fixtures

**Solution**:
- Check `tests/conftest.py` for fixtures
- Ensure test database is initialized
- Use `pytest -v` for verbose output

### Configuration Issues

**Problem**: API keys not found

**Solution**:
```bash
# Create .env file from example
cp .env.example .env

# Edit .env and add your keys
GEMINI_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
```

## Best Practices

### 1. Follow PEP 8
- Line length: 100 characters (configured in pyproject.toml)
- Use snake_case for functions/variables
- Use PascalCase for classes
- Use UPPER_CASE for constants

### 2. Type Hints
- Add type hints to all new functions
- Use `Optional[T]` for nullable values
- Use `List[T]`, `Dict[K, V]` for collections

### 3. Error Handling
- Use specific exceptions
- Log errors with context
- Provide helpful error messages

### 4. Testing
- Write tests for all new code
- Aim for 80%+ coverage
- Test edge cases and error conditions

### 5. Documentation
- Document all public APIs
- Update docs/ when adding features
- Keep CHANGELOG.md current

## Resources

### Internal Documentation
- `docs/V2.1.0_REFACTOR_REPORT.md` - Full implementation plan
- `docs/V2.1.0_SESSION_SUMMARY.md` - Session summary
- `docs/ROADMAP.md` - Future roadmap
- `docs/ARCHITECTURE.md` - Architecture overview

### External Resources
- [Textual Documentation](https://textual.textualize.io/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Click Documentation](https://click.palletsprojects.com/)
- [pytest Documentation](https://docs.pytest.org/)

## Getting Help

### Questions About:

- **Architecture**: Read `docs/ARCHITECTURE.md` and `docs/V2.1.0_REFACTOR_REPORT.md`
- **Code Style**: See `pyproject.toml` for black/ruff config
- **Testing**: Check `tests/conftest.py` for fixtures
- **APIs**: Refer to function docstrings and `docs/API.md`

### Contributing

1. Read `CONTRIBUTING.md`
2. Create feature branch
3. Write code and tests
4. Run quality checks
5. Submit pull request

## Next Steps

1. **Complete Phase 1b**:
   - Extract database schema
   - Create migration system
   - Implement cache module
   - Create model classes

2. **Set Up Testing**:
   - Configure pytest properly
   - Create test fixtures
   - Write first 20 unit tests

3. **Begin Phase 2**:
   - Plugin system foundation
   - Base scraper class
   - Scraper manager

---

**Maintainer**: WebScrape-TUI Development Team
**Last Updated**: October 3, 2025
**Version**: v2.1.0-dev
